# ParkBoard - Single Sign-On (SSO) Implementation Guide
**Generated:** 2025-10-07 09:43:38
**Purpose:** Comprehensive SSO architecture evaluation and implementation strategy

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Current Authentication State](#current-authentication-state)
3. [SSO Architecture Options](#sso-architecture-options)
4. [Implementation Strategy (Recommended)](#implementation-strategy-recommended)
5. [Technical Implementation](#technical-implementation)
6. [Migration Path](#migration-path)
7. [Security Considerations](#security-considerations)
8. [Cost Analysis](#cost-analysis)
9. [Timeline & Milestones](#timeline--milestones)
10. [Decision Matrix](#decision-matrix)

---

## Executive Summary

### Current State
- **Stack:** Next.js 15 + Supabase Auth + PostgreSQL
- **Auth Method:** Email/password only
- **User Type:** Condo residents (single building initially)
- **Scale:** MVP targeting 50-200 users

### SSO Value Proposition

**For ParkBoard (Current Scale):**
- ❌ **Not critical** for MVP launch
- 🟡 **Nice to have** for user experience
- ✅ **Future-proofing** for enterprise sales

**For Enterprise Customers (Future):**
- ✅ **Must-have** feature for property management companies
- ✅ **Compliance** requirement (centralized user management)
- ✅ **Security** benefit (single point of auth control)

### Recommendation

**Phase 1 (MVP - Next 2 months):**
- ✅ Implement **OAuth Social Login** (Google, Facebook)
- ⏸️ Defer enterprise SSO (SAML/OIDC) until customer demand

**Phase 2 (Enterprise - 6+ months):**
- ✅ Add **SAML 2.0** for enterprise SSO
- ✅ Add **OIDC** for modern identity providers

**Why this phased approach?**
1. Social OAuth provides 80% of UX benefits with 20% of complexity
2. SAML/OIDC adds significant development time (3-4 weeks)
3. No current customers require enterprise SSO
4. Supabase natively supports OAuth (built-in)
5. SAML requires custom implementation or third-party service

---

## Current Authentication State

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────┐
│              CURRENT AUTH FLOW                          │
└─────────────────────────────────────────────────────────┘

User
  │
  ├─► Register (email + password)
  │     │
  │     ├─► POST /api/auth/signup
  │     │     └─► Supabase.auth.signUp()
  │     │           └─► Creates auth.users record
  │     │
  │     └─► POST /api/profiles
  │           └─► Creates user_profiles record
  │
  └─► Login (email + password)
        │
        └─► Supabase.auth.signInWithPassword()
              │
              ├─► Session stored in httpOnly cookie
              └─► JWT token (1 hour expiry)
```

### Current Components

**Files:**
- `lib/supabase/client.ts` - Browser client (OAuth-ready)
- `lib/supabase/server.ts` - Server client (OAuth-ready)
- `components/auth/AuthWrapper.tsx` - Session management
- `app/(auth)/login/page.tsx` - Email/password login
- `app/(auth)/register/page.tsx` - Email/password signup

**Supabase Auth Features Already Available:**
- ✅ OAuth providers (Google, GitHub, Facebook, etc.)
- ✅ Magic links (passwordless email)
- ✅ Phone/SMS auth
- ❌ SAML 2.0 (not built-in)
- ❌ OIDC (built-in but requires configuration)

### Current Gaps for SSO

1. **No OAuth UI**
   - Login page only has email/password form
   - No "Continue with Google" buttons

2. **No SAML Support**
   - Cannot integrate with enterprise IdPs (Okta, Azure AD, OneLogin)

3. **No Admin Dashboard**
   - No way to manage SSO configurations per tenant
   - No SAML metadata endpoints

4. **Single Tenant Only**
   - Current schema assumes single condo
   - SSO typically requires multi-tenant architecture

---

## SSO Architecture Options

### Option 1: OAuth 2.0 Social Login (Recommended for Phase 1)

**What it is:**
- Users sign in with existing accounts (Google, Facebook, Microsoft)
- "Continue with Google" button
- No password management needed

**Supabase Support:**
- ✅ Built-in, native support
- ✅ Just enable in Supabase dashboard
- ✅ Minimal code changes

**Pros:**
- ⚡ Fast implementation (1-2 days)
- 💰 Free (no additional costs)
- 🎯 Improves UX (users prefer social login)
- 🔐 Reduces password security risks
- 📈 Higher conversion rates (fewer form fields)

**Cons:**
- ❌ Not true "enterprise SSO"
- ❌ Still need email/password as fallback
- ❌ Each provider must be configured separately
- ❌ Users without Google/FB accounts excluded

**Architecture:**

```
┌─────────────────────────────────────────────────────────┐
│              OAUTH 2.0 FLOW                             │
└─────────────────────────────────────────────────────────┘

User clicks "Continue with Google"
  │
  ├─► Redirect to Google OAuth
  │     │
  │     ├─► User logs in at Google
  │     │
  │     └─► Google redirects back with auth code
  │
  ├─► Supabase exchanges code for user info
  │     │
  │     └─► Creates/updates auth.users record
  │
  └─► Create/update user_profiles
        │
        └─► Redirect to /slots
```

**Implementation Complexity:** ⭐ (1/5)

---

### Option 2: SAML 2.0 Enterprise SSO (Recommended for Phase 2)

**What it is:**
- Corporate identity provider integration (Okta, Azure AD, OneLogin)
- Company manages user access centrally
- Users click "Sign in with [CompanyName]"

**Supabase Support:**
- ❌ Not built-in
- ⚠️ Requires custom implementation
- 🔧 Or use third-party service (WorkOS, Auth0, FusionAuth)

**Pros:**
- ✅ True enterprise SSO
- ✅ Centralized user management
- ✅ Compliance friendly (SOC2, HIPAA)
- ✅ Single point of access control
- ✅ Works with corporate IT policies

**Cons:**
- ⏰ Complex implementation (3-4 weeks)
- 💰 May require paid service ($$$)
- 🔧 Requires SAML expertise
- 📋 Certificate management overhead
- 🏢 Only needed for enterprise customers

**Architecture:**

```
┌─────────────────────────────────────────────────────────┐
│              SAML 2.0 FLOW                              │
└─────────────────────────────────────────────────────────┘

User visits parkboard.com
  │
  ├─► Detects corporate email (@bigcorp.com)
  │     └─► Redirects to bigcorp's IdP
  │
  ├─► User logs in at corporate IdP (Okta/Azure AD)
  │     │
  │     └─► IdP sends SAML assertion
  │
  ├─► ParkBoard validates SAML assertion
  │     │
  │     ├─► Check signature (XML digital signature)
  │     ├─► Verify certificate
  │     └─► Extract user attributes (email, name, groups)
  │
  ├─► Create/update user in Supabase
  │     │
  │     └─► Map SAML attributes → user_profiles
  │
  └─► Create session & redirect to /slots
```

**Implementation Complexity:** ⭐⭐⭐⭐⭐ (5/5)

---

### Option 3: OpenID Connect (OIDC) - Modern Alternative to SAML

**What it is:**
- JSON-based authentication (vs SAML's XML)
- Built on OAuth 2.0
- Simpler than SAML, more modern

**Supabase Support:**
- ✅ Built-in support
- ⚠️ Requires manual provider configuration
- 🔧 Easier than SAML, harder than OAuth

**Pros:**
- ✅ Modern standard (Google, Microsoft support)
- ✅ Simpler than SAML (JSON vs XML)
- ✅ Better developer experience
- ✅ Mobile-friendly
- ✅ Works with Azure AD, Google Workspace

**Cons:**
- ⚠️ Not all enterprise IdPs support OIDC (some only do SAML)
- 🔧 Requires configuration per tenant
- 📋 Certificate/key management still needed

**Architecture:**

```
┌─────────────────────────────────────────────────────────┐
│              OIDC FLOW                                  │
└─────────────────────────────────────────────────────────┘

User clicks "Sign in with Azure AD"
  │
  ├─► Redirect to Azure AD /authorize endpoint
  │     │
  │     ├─► User logs in
  │     │
  │     └─► Azure AD redirects with auth code
  │
  ├─► Exchange code for ID token (JWT)
  │     │
  │     └─► POST to Azure AD /token endpoint
  │
  ├─► Validate ID token
  │     │
  │     ├─► Verify signature (JWT)
  │     ├─► Check issuer, audience, expiry
  │     └─► Extract user claims (email, name, groups)
  │
  └─► Create Supabase session
```

**Implementation Complexity:** ⭐⭐⭐ (3/5)

---

### Option 4: Hybrid Approach (BEST for ParkBoard)

**What it is:**
- Support multiple auth methods
- Users choose based on context

**Supported Methods:**
1. Email/password (fallback, always available)
2. OAuth social (Google, Facebook) - Phase 1
3. SAML/OIDC enterprise - Phase 2 (on-demand)

**Architecture:**

```
┌─────────────────────────────────────────────────────────┐
│            HYBRID AUTH ARCHITECTURE                     │
└─────────────────────────────────────────────────────────┘

Login Page
  │
  ├─► Individual Users (residents)
  │     │
  │     ├─► Email/Password (always available)
  │     │
  │     └─► Social OAuth (Google, Facebook)
  │
  └─► Enterprise Users (property managers)
        │
        ├─► SAML 2.0 (Okta, Azure AD)
        │
        └─► OIDC (Google Workspace, Azure AD)
```

**Pros:**
- ✅ Maximum flexibility
- ✅ Gradual rollout (start with OAuth, add SAML later)
- ✅ Supports all user types
- ✅ No vendor lock-in

**Cons:**
- 🔧 More complex codebase
- 🧪 More testing required
- 📋 More configuration to maintain

**Implementation Complexity:** ⭐⭐⭐⭐ (4/5 total, but can be phased)

---

## Implementation Strategy (Recommended)

### Phase 1: OAuth Social Login (Weeks 1-2)

**Goal:** Improve user experience for individual residents

**Providers to Support:**
1. ✅ Google (highest adoption in PH)
2. ✅ Facebook (high social media usage)
3. ⏸️ Apple (defer - requires paid developer account)
4. ⏸️ Microsoft (defer - enterprise-focused)

**Why Google & Facebook?**
- **Google:** 90%+ of users have Gmail
- **Facebook:** High social media penetration in Philippines
- **Combined:** Covers ~95% of potential users

**Implementation Steps:**

1. **Enable OAuth in Supabase Dashboard** (30 minutes)
   - Navigate to Authentication → Providers
   - Enable Google OAuth
   - Configure redirect URLs
   - Get client ID/secret from Google Cloud Console

2. **Update Login Page** (4 hours)
   - Add "Continue with Google" button
   - Add "Continue with Facebook" button
   - Implement OAuth callback handler

3. **Handle OAuth Callback** (2 hours)
   - Create `/auth/callback/route.ts`
   - Exchange auth code for session
   - Create/update user_profile

4. **Update AuthWrapper** (1 hour)
   - Already handles OAuth sessions
   - No changes needed (uses Supabase auth state)

5. **Testing** (4 hours)
   - Test Google login flow
   - Test Facebook login flow
   - Test profile creation/linking
   - Test edge cases (email conflicts)

**Total Effort:** 1-2 days

**Deliverables:**
- ✅ Users can login with Google/Facebook
- ✅ Email/password still works as fallback
- ✅ Profile auto-created from OAuth data

---

### Phase 2: Enterprise SSO (SAML/OIDC) - Months 6+

**Trigger:** First enterprise customer requires SSO

**Prerequisites:**
1. Multi-tenant architecture implemented
2. Admin dashboard for SSO configuration
3. Customer willing to pay premium for SSO

**Decision Tree:**

```
Enterprise Customer Signs Up
  │
  ├─► What IdP do they use?
  │
  ├─► Azure AD / Google Workspace
  │     └─► Implement OIDC (simpler)
  │
  ├─► Okta / OneLogin / Legacy IdP
  │     └─► Implement SAML 2.0 (required)
  │
  └─► Custom / In-house IdP
        └─► Request OIDC or SAML support
```

**Implementation Approach:**

**Option A: Build In-House** (3-4 weeks, $0 additional cost)
- Write custom SAML/OIDC handlers
- Manage certificates manually
- Higher maintenance burden

**Option B: Use SSO Service** (1-2 weeks, $99-299/month)
- **WorkOS** (Recommended)
  - Best for SAML + OIDC
  - $125/month for SSO
  - Excellent Next.js integration

- **Auth0**
  - Full-featured
  - $240/month for SSO
  - Overkill for our needs

- **FusionAuth**
  - Self-hosted option
  - Free for SSO
  - More DevOps overhead

**Recommendation:** Use **WorkOS** when needed

---

## Technical Implementation

### Phase 1: OAuth Social Login (Detailed)

#### Step 1: Supabase Configuration

**Google OAuth Setup:**

1. **Create Google OAuth App**
   - Go to [Google Cloud Console](https://console.cloud.google.com)
   - Create new project: "ParkBoard"
   - Enable Google+ API
   - Create OAuth 2.0 credentials

2. **Configure Redirect URLs**
   ```
   Development:
   <!-- http://localhost:3000/auth/callback -->
   http://localhost:3000/auth/v1/callback

   Production:
   https://parkboard.vercel.app/auth/callback
   https://cgbkknefvggnhkvmuwsa.supabase.co/auth/v1/callback
   ```

3. **Add Credentials to Supabase**
   - Dashboard → Authentication → Providers → Google
   - Paste Client ID
   - Paste Client Secret
   - Enable provider

**Facebook OAuth Setup:**

Similar process but via [Facebook Developers](https://developers.facebook.com)

#### Step 2: Update Login Page

**File:** `app/(auth)/login/page.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

export default function LoginPage() {
  const router = useRouter()
  const supabase = createClient()

  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  // ═══════════════════════════════════════════════════════════════
  // EMAIL/PASSWORD LOGIN (Existing)
  // ═══════════════════════════════════════════════════════════════

  async function handleEmailLogin(e: React.FormEvent) {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email,
        password
      })

      if (signInError) throw signInError

      router.push('/slots')

    } catch (err: any) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // OAUTH GOOGLE LOGIN (New)
  // ═══════════════════════════════════════════════════════════════

  async function handleGoogleLogin() {
    setLoading(true)
    setError(null)

    try {
      const { error: oauthError } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          }
        }
      })

      if (oauthError) throw oauthError

      // Supabase will redirect to Google login page
      // User will be redirected back to /auth/callback after login

    } catch (err: any) {
      setError(err.message)
      setLoading(false)
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // OAUTH FACEBOOK LOGIN (New)
  // ═══════════════════════════════════════════════════════════════

  async function handleFacebookLogin() {
    setLoading(true)
    setError(null)

    try {
      const { error: oauthError } = await supabase.auth.signInWithOAuth({
        provider: 'facebook',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (oauthError) throw oauthError

    } catch (err: any) {
      setError(err.message)
      setLoading(false)
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // RENDER
  // ═══════════════════════════════════════════════════════════════

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-2xl text-center">Login to ParkBoard</CardTitle>
        </CardHeader>
        <CardContent>
          {/* ═══════════════════════════════════════════════════════ */}
          {/* SOCIAL LOGIN BUTTONS (New)                             */}
          {/* ═══════════════════════════════════════════════════════ */}

          <div className="space-y-3 mb-6">
            <Button
              type="button"
              variant="outline"
              onClick={handleGoogleLogin}
              disabled={loading}
              className="w-full flex items-center justify-center gap-2"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                {/* Google logo SVG */}
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Continue with Google
            </Button>

            <Button
              type="button"
              variant="outline"
              onClick={handleFacebookLogin}
              disabled={loading}
              className="w-full flex items-center justify-center gap-2"
            >
              <svg className="w-5 h-5" fill="#1877F2" viewBox="0 0 24 24">
                {/* Facebook logo SVG */}
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Continue with Facebook
            </Button>
          </div>

          {/* ═══════════════════════════════════════════════════════ */}
          {/* DIVIDER                                                 */}
          {/* ═══════════════════════════════════════════════════════ */}

          <div className="relative mb-6">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-white px-2 text-gray-500">Or continue with email</span>
            </div>
          </div>

          {/* ═══════════════════════════════════════════════════════ */}
          {/* EMAIL/PASSWORD FORM (Existing)                          */}
          {/* ═══════════════════════════════════════════════════════ */}

          <form onSubmit={handleEmailLogin} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium mb-1">
                Email
              </label>
              <Input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>

            <div>
              <label htmlFor="password" className="block text-sm font-medium mb-1">
                Password
              </label>
              <Input
                id="password"
                type="password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>

            {error && (
              <div className="bg-red-50 text-red-800 text-sm p-3 rounded">
                {error}
              </div>
            )}

            <Button type="submit" disabled={loading} className="w-full">
              {loading ? 'Logging in...' : 'Login'}
            </Button>
          </form>

          {/* ═══════════════════════════════════════════════════════ */}
          {/* SIGNUP LINK                                             */}
          {/* ═══════════════════════════════════════════════════════ */}

          <div className="mt-4 text-center text-sm">
            Don't have an account?{' '}
            <a href="/register" className="text-blue-600 hover:underline">
              Sign up
            </a>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

#### Step 3: OAuth Callback Handler

**File:** `app/auth/callback/route.ts` (New)

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const origin = requestUrl.origin

  if (code) {
    const supabase = createClient()

    // ═══════════════════════════════════════════════════════════════
    // EXCHANGE AUTH CODE FOR SESSION
    // ═══════════════════════════════════════════════════════════════

    const { data, error } = await supabase.auth.exchangeCodeForSession(code)

    if (error) {
      console.error('OAuth callback error:', error)
      return NextResponse.redirect(`${origin}/login?error=oauth_failed`)
    }

    // ═══════════════════════════════════════════════════════════════
    // CREATE/UPDATE USER PROFILE
    // ═══════════════════════════════════════════════════════════════

    const user = data.user

    if (user) {
      // Check if profile exists
      const { data: existingProfile } = await supabase
        .from('user_profiles')
        .select('id')
        .eq('id', user.id)
        .single()

      if (!existingProfile) {
        // Create new profile from OAuth data
        const { error: profileError } = await supabase
          .from('user_profiles')
          .insert({
            id: user.id,
            email: user.email!,
            name: user.user_metadata.full_name || user.email!.split('@')[0],
            phone: user.user_metadata.phone || '',  // Will need to collect later
            unit_number: '',  // Will need to collect later
          })

        if (profileError) {
          console.error('Profile creation error:', profileError)
          // Don't block login, redirect to profile completion page
          return NextResponse.redirect(`${origin}/profile/complete`)
        }
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // REDIRECT TO APP
    // ═══════════════════════════════════════════════════════════════

    return NextResponse.redirect(`${origin}/slots`)
  }

  // No code provided, redirect to login
  return NextResponse.redirect(`${origin}/login`)
}
```

#### Step 4: Profile Completion Page

**File:** `app/profile/complete/page.tsx` (New)

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { useAuth } from '@/components/auth/AuthWrapper'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

export default function CompleteProfilePage() {
  const router = useRouter()
  const supabase = createClient()
  const { user } = useAuth()

  const [phone, setPhone] = useState('')
  const [unitNumber, setUnitNumber] = useState('')
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      const { error: updateError } = await supabase
        .from('user_profiles')
        .update({
          phone: phone,
          unit_number: unitNumber
        })
        .eq('id', user!.id)

      if (updateError) throw updateError

      router.push('/slots')

    } catch (err: any) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Complete Your Profile</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-gray-600 mb-4">
            We need a few more details to set up your account.
          </p>

          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label htmlFor="phone" className="block text-sm font-medium mb-1">
                Phone Number <span className="text-red-500">*</span>
              </label>
              <Input
                id="phone"
                type="tel"
                required
                placeholder="+639171234567"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
              />
            </div>

            <div>
              <label htmlFor="unit_number" className="block text-sm font-medium mb-1">
                Unit Number <span className="text-red-500">*</span>
              </label>
              <Input
                id="unit_number"
                type="text"
                required
                placeholder="10A"
                value={unitNumber}
                onChange={(e) => setUnitNumber(e.target.value)}
              />
            </div>

            {error && (
              <div className="bg-red-50 text-red-800 text-sm p-3 rounded">
                {error}
              </div>
            )}

            <Button type="submit" disabled={loading} className="w-full">
              {loading ? 'Saving...' : 'Complete Profile'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

#### Step 5: Update AuthWrapper

**File:** `components/auth/AuthWrapper.tsx`

**Good News:** No changes needed!

AuthWrapper already uses `supabase.auth.getSession()` which works for both:
- Email/password sessions
- OAuth sessions

The existing `onAuthStateChange` listener handles OAuth logins automatically.

---

### Phase 2: Enterprise SSO (When Needed)

#### Using WorkOS (Recommended)

**Why WorkOS?**
- Built for Next.js
- Handles SAML + OIDC + OAuth
- $125/month (reasonable for enterprise)
- Excellent docs & support
- No vendor lock-in (can migrate off)

**Architecture with WorkOS:**

```
┌─────────────────────────────────────────────────────────┐
│         WORKOS INTEGRATION ARCHITECTURE                 │
└─────────────────────────────────────────────────────────┘

User (enterprise employee)
  │
  ├─► Login page detects corporate email
  │     └─► Redirects to WorkOS SSO portal
  │
  ├─► WorkOS handles IdP communication
  │     │
  │     ├─► SAML assertion exchange
  │     └─► OIDC token exchange
  │
  ├─► WorkOS redirects back with profile data
  │
  ├─► ParkBoard validates WorkOS token
  │     └─► Create/update Supabase user
  │
  └─► Create session & redirect to /slots
```

**Implementation Steps:**

1. **Install WorkOS SDK** (5 minutes)
   ```bash
   npm install @workos-inc/node
   ```

2. **Configure WorkOS** (1 hour)
   - Sign up at workos.com
   - Create organization
   - Configure SAML connection per customer
   - Get API key & client ID

3. **Add SSO Route** (4 hours)
   ```typescript
   // app/api/auth/sso/route.ts
   import { WorkOS } from '@workos-inc/node'

   const workos = new WorkOS(process.env.WORKOS_API_KEY)

   export async function GET(request: NextRequest) {
     const email = request.nextUrl.searchParams.get('email')

     // Detect organization from email domain
     const domain = email.split('@')[1]

     // Get WorkOS connection for this domain
     const { data: connections } = await workos.sso.listConnections({
       domains: [domain]
     })

     if (connections.length === 0) {
       // No SSO configured for this domain, use regular login
       return NextResponse.redirect('/login')
     }

     // Generate SSO login URL
     const authorizationUrl = workos.sso.getAuthorizationUrl({
       connection: connections[0].id,
       clientId: process.env.WORKOS_CLIENT_ID,
       redirectUri: `${process.env.NEXT_PUBLIC_URL}/auth/sso/callback`
     })

     return NextResponse.redirect(authorizationUrl)
   }
   ```

4. **Add SSO Callback** (4 hours)
   ```typescript
   // app/api/auth/sso/callback/route.ts
   export async function GET(request: NextRequest) {
     const code = request.nextUrl.searchParams.get('code')

     // Exchange code for profile
     const { profile } = await workos.sso.getProfileAndToken({ code })

     // Create Supabase user
     // Map profile data to user_profiles
     // Create session
     // Redirect to /slots
   }
   ```

5. **Update Login Page** (2 hours)
   - Detect corporate email domains
   - Show "Continue with [CompanyName]" button
   - Handle SSO redirects

**Total Effort:** 1-2 weeks (including testing)

**Cost:** $125/month (WorkOS SSO plan)

---

## Migration Path

### From Current State to OAuth (Phase 1)

**Zero Downtime Migration:**

1. **Week 1: Preparation**
   - Configure Google/Facebook OAuth in Supabase
   - Add OAuth buttons to login page (hidden behind feature flag)
   - Deploy to staging

2. **Week 2: Soft Launch**
   - Enable OAuth for internal testers
   - Collect feedback
   - Fix bugs

3. **Week 3: Public Launch**
   - Enable OAuth for all users
   - Email announcement: "New! Login with Google/Facebook"
   - Monitor for issues

4. **Week 4+: Observation**
   - Track OAuth adoption rate
   - Identify and fix edge cases
   - Keep email/password as fallback

**Rollback Plan:**
- If OAuth causes issues, hide buttons via feature flag
- Email/password still works (zero impact)

---

### From OAuth to Enterprise SSO (Phase 2)

**Per-Customer Rollout:**

1. **Customer Signs Up**
   - Sales team qualifies customer
   - Customer agrees to pay SSO premium ($500-1000/month)

2. **SSO Configuration** (2-3 days per customer)
   - Customer provides SAML metadata OR OIDC config
   - Configure in WorkOS
   - Test with customer's IT team

3. **User Migration**
   - Existing email/password users can link to SSO
   - New users auto-provisioned via SSO

4. **Go Live**
   - Customer's IT enables SSO
   - Users see "Sign in with [CompanyName]" option

**No Impact on Existing Users:**
- Other customers still use email/password or OAuth
- Multi-tenant architecture keeps customers isolated

---

## Security Considerations

### OAuth Security

**Threats:**
1. **OAuth Hijacking**
   - Attacker intercepts auth code
   - **Mitigation:** PKCE (Proof Key for Code Exchange) - Supabase handles this

2. **Account Takeover via Email Change**
   - User changes email in Google, links to different ParkBoard account
   - **Mitigation:** Verify email ownership before linking accounts

3. **Redirect URI Manipulation**
   - Attacker changes redirect_uri to steal auth code
   - **Mitigation:** Whitelist redirect URIs in provider config

**Implementation:**
```typescript
// Always validate redirect URI matches whitelist
const ALLOWED_REDIRECTS = [
  'http://localhost:3000/auth/callback',
  'https://parkboard.vercel.app/auth/callback'
]

const redirectTo = request.nextUrl.searchParams.get('redirect')

if (!ALLOWED_REDIRECTS.includes(redirectTo)) {
  throw new Error('Invalid redirect URI')
}
```

### SAML Security

**Threats:**
1. **XML Signature Wrapping**
   - Attacker modifies SAML assertion after signature
   - **Mitigation:** Use battle-tested SAML library (WorkOS, passport-saml)

2. **Certificate Expiry**
   - SAML certificates expire, breaking SSO
   - **Mitigation:** Monitor cert expiry, auto-alert 30 days before

3. **Replay Attacks**
   - Attacker reuses old SAML assertion
   - **Mitigation:** Check assertion timestamp, enforce short TTL

**Implementation:**
```typescript
// Always validate SAML assertion
function validateSAMLAssertion(assertion) {
  // 1. Verify signature
  if (!verifySAMLSignature(assertion)) {
    throw new Error('Invalid SAML signature')
  }

  // 2. Check expiry
  const expiresAt = new Date(assertion.NotOnOrAfter)
  if (expiresAt < new Date()) {
    throw new Error('SAML assertion expired')
  }

  // 3. Check issuer
  if (assertion.Issuer !== expectedIssuer) {
    throw new Error('Unknown SAML issuer')
  }

  return true
}
```

### General SSO Security

**Best Practices:**

1. **Always Use HTTPS**
   - OAuth/SAML require secure redirect URLs
   - Enforce HTTPS in production

2. **Short Session Timeouts**
   - SSO sessions should timeout after inactivity
   - Force re-authentication for sensitive operations

3. **Audit Logging**
   - Log all SSO login attempts
   - Alert on suspicious patterns (impossible travel, etc.)

4. **MFA Support**
   - Respect MFA configured at IdP
   - Don't bypass IdP's security policies

---

## Cost Analysis

### Phase 1: OAuth (Social Login)

| Item | Cost | Notes |
|------|------|-------|
| Google OAuth | $0 | Free |
| Facebook OAuth | $0 | Free |
| Development Time | 16 hours | $0 (internal) |
| Testing Time | 8 hours | $0 (internal) |
| **Total** | **$0** | Zero additional cost |

**ROI:**
- 📈 **+30% conversion rate** (users prefer social login)
- ⏱️ **-50% registration time** (fewer form fields)
- 🔐 **+Security** (no password to manage)

---

### Phase 2: Enterprise SSO (SAML/OIDC)

#### Option A: Build In-House

| Item | Cost | Notes |
|------|------|-------|
| Development Time | 160 hours (4 weeks) | $0 (internal) |
| SAML Library | $0 | Open source (passport-saml) |
| Certificate Management | $0 | Let's Encrypt |
| Maintenance | 10 hours/month | Ongoing |
| **Total** | **$0 upfront** | High maintenance burden |

**Pros:**
- No monthly fees
- Full control

**Cons:**
- 4 weeks development time
- Security risk (DIY SAML is hard)
- High maintenance

---

#### Option B: Use WorkOS (Recommended)

| Item | Cost | Notes |
|------|------|-------|
| WorkOS SSO Plan | $125/month | Per-tenant pricing |
| Development Time | 40 hours (1 week) | Integration only |
| Maintenance | 2 hours/month | Minimal |
| **Total** | **$125/month** | + $0 upfront |

**Pros:**
- ⚡ Fast implementation (1 week)
- 🔐 Battle-tested security
- 📚 Excellent documentation
- 🛠️ Handles certificate rotation

**Cons:**
- 💰 Monthly cost
- 🔒 Vendor dependency

**Break-even Analysis:**
- Internal dev cost: ~$50/hour
- Build in-house: 160 hours = $8,000
- WorkOS: $125/month = $1,500/year
- **Breakeven:** 5.3 years

**Recommendation:** Use WorkOS (faster, more secure, lower risk)

---

#### Option C: Use Auth0

| Item | Cost | Notes |
|------|------|-------|
| Auth0 Essentials | $240/month | 1,000 MAU included |
| Development Time | 40 hours | Similar to WorkOS |
| **Total** | **$240/month** | More expensive |

**Why not Auth0?**
- Nearly 2x price of WorkOS
- Overkill for our needs (we only need SSO, not full auth platform)
- We already use Supabase Auth for base auth

---

### Revenue Impact

**Enterprise SSO as Premium Feature:**

| Tier | Monthly Price | SSO Included? |
|------|--------------|---------------|
| Basic | $99 | ❌ No |
| Premium | $299 | ✅ Yes (OIDC) |
| Enterprise | $999 | ✅ Yes (SAML + OIDC) |

**Pricing Strategy:**
- Charge $200-400/month premium for SSO
- Covers WorkOS cost ($125) + profit margin
- Positions ParkBoard as enterprise-ready

**Example Customer:**
- Large property management company
- 10 condos on platform
- Requires SSO for compliance
- Willing to pay $999/month (vs $99 × 10 = $990)
- **Additional Revenue:** $1,000/month
- **WorkOS Cost:** $125/month
- **Net Profit:** $875/month per enterprise customer

**ROI:** Positive from first enterprise customer

---

## Timeline & Milestones

### Phase 1: OAuth Social Login

| Week | Milestone | Deliverable |
|------|-----------|-------------|
| **Week 1** | Supabase configuration | OAuth providers enabled |
| | Login page updates | "Continue with Google/Facebook" buttons |
| | Callback handler | `/auth/callback` route |
| | Profile completion page | `/profile/complete` page |
| **Week 2** | Testing | All OAuth flows tested |
| | Bug fixes | Edge cases handled |
| | Documentation | User guide for social login |
| **Week 3** | Soft launch | OAuth enabled for beta users |
| | Monitoring | Track adoption, errors |
| **Week 4** | Public launch | OAuth available to all users |

**Go/No-Go Criteria (End of Week 2):**
- ✅ Google login works end-to-end
- ✅ Facebook login works end-to-end
- ✅ Profile creation/linking works
- ✅ Email/password still works as fallback
- ✅ No critical bugs

---

### Phase 2: Enterprise SSO (Triggered by Customer Demand)

| Week | Milestone | Deliverable |
|------|-----------|-------------|
| **Week 1** | Architecture decision | Build vs Buy decision made |
| | WorkOS setup | Account created, configured |
| | Customer discovery | Gather SAML metadata from customer |
| **Week 2** | SSO routes | `/api/auth/sso/*` routes |
| | Login page updates | "Sign in with [Company]" |
| | WorkOS integration | Connection configured |
| **Week 3** | Testing with customer | IT team validates SSO |
| | User migration | Link existing accounts to SSO |
| | Documentation | Customer onboarding guide |
| **Week 4** | Go live | SSO enabled for customer |
| | Monitoring | Track logins, errors |
| | Support | 24/7 support during rollout |

**Go/No-Go Criteria (End of Week 3):**
- ✅ Customer's IT approves SSO configuration
- ✅ Test users can login via SSO
- ✅ Profile data syncs correctly
- ✅ Security audit passed
- ✅ Rollback plan documented

---

## Decision Matrix

### Should We Implement OAuth Now?

| Factor | Score (1-5) | Weight | Total |
|--------|-------------|--------|-------|
| User Experience | 5 | 30% | 1.5 |
| Implementation Ease | 5 | 20% | 1.0 |
| Cost | 5 | 15% | 0.75 |
| Security | 4 | 20% | 0.8 |
| Competitive Advantage | 3 | 15% | 0.45 |
| **TOTAL** | - | - | **4.5/5** |

**Verdict:** ✅ **YES, implement OAuth in Phase 1**

**Rationale:**
- High UX impact with minimal effort
- Zero additional cost
- Improves security posture
- Standard feature in modern apps

---

### Should We Implement Enterprise SSO Now?

| Factor | Score (1-5) | Weight | Total |
|--------|-------------|--------|-------|
| Current Demand | 1 | 30% | 0.3 |
| Implementation Ease | 2 | 20% | 0.4 |
| Cost | 3 | 15% | 0.45 |
| Revenue Impact | 2 | 20% | 0.4 |
| Competitive Need | 2 | 15% | 0.3 |
| **TOTAL** | - | - | **1.85/5** |

**Verdict:** ⏸️ **NO, defer to Phase 2 (when customer demands)**

**Rationale:**
- No current customers require SAML
- High complexity (3-4 weeks dev time)
- Can implement quickly when needed (1-2 weeks with WorkOS)
- Focus on core product features first

---

## Recommendations Summary

### Immediate Actions (Next 2 Weeks)

1. ✅ **Implement OAuth Social Login**
   - Google OAuth (highest priority)
   - Facebook OAuth (secondary)
   - Profile completion flow

2. ✅ **Add Feature Flag**
   - Control OAuth rollout
   - Easy rollback if issues arise

3. ✅ **Update Documentation**
   - User guide for social login
   - Developer guide for OAuth flow

4. ✅ **Set Up Monitoring**
   - Track OAuth adoption rate
   - Alert on OAuth errors

---

### Future Actions (Month 6+)

1. ⏸️ **Wait for Enterprise Customer**
   - Don't build SAML until customer commits
   - Qualify customer willingness to pay premium

2. ⏸️ **Choose SSO Provider**
   - Default to WorkOS ($125/month)
   - Evaluate Auth0 if WorkOS doesn't meet needs

3. ⏸️ **Implement Multi-Tenant Architecture**
   - Required for per-customer SSO configs
   - Add `organization_id` to schema
   - Isolate customer data

4. ⏸️ **Build Admin Dashboard**
   - SSO configuration UI
   - Connection status monitoring
   - User provisioning controls

---

## Appendix

### OAuth vs SAML vs OIDC Comparison

| Feature | OAuth 2.0 | SAML 2.0 | OIDC |
|---------|-----------|----------|------|
| **Use Case** | Social login | Enterprise SSO | Modern SSO |
| **Format** | JSON | XML | JSON (JWT) |
| **Complexity** | Low | High | Medium |
| **Mobile Support** | Excellent | Poor | Excellent |
| **Enterprise Adoption** | Medium | High | Growing |
| **Supabase Support** | ✅ Built-in | ❌ None | ✅ Manual config |
| **Setup Time** | 1 day | 1-2 weeks | 3-5 days |

---

### Glossary

- **SSO (Single Sign-On):** Login once, access multiple apps
- **IdP (Identity Provider):** System that manages user identities (Okta, Azure AD)
- **SP (Service Provider):** App that relies on IdP for auth (ParkBoard)
- **OAuth 2.0:** Authorization framework for delegated access
- **SAML 2.0:** XML-based SSO protocol (enterprise standard)
- **OIDC:** Authentication layer on top of OAuth 2.0
- **PKCE:** Proof Key for Code Exchange (OAuth security extension)
- **JWT:** JSON Web Token (secure token format)

---

### References

**Supabase Auth Docs:**
- https://supabase.com/docs/guides/auth/social-login
- https://supabase.com/docs/guides/auth/social-login/auth-google
- https://supabase.com/docs/guides/auth/social-login/auth-facebook

**WorkOS Docs:**
- https://workos.com/docs/sso/guide
- https://workos.com/docs/integrations/nextjs

**OAuth 2.0 Spec:**
- https://oauth.net/2/

**SAML 2.0 Spec:**
- https://en.wikipedia.org/wiki/SAML_2.0

---

## Conclusion

**Recommended Path:**

1. **Now (Weeks 1-2):** Implement OAuth social login (Google, Facebook)
   - High impact, low effort
   - Zero additional cost
   - Immediate UX improvement

2. **Later (Month 6+):** Implement enterprise SSO when customer demands
   - Use WorkOS ($125/month)
   - Charge premium ($200-400/month)
   - ROI positive from first customer

**Key Principle:**
> "Build what users need now, not what they might need later."

OAuth solves today's problem (user friction). SAML solves tomorrow's problem (enterprise sales). Focus on today.

---

**Document Version:** 1.0
**Author:** SSO Architecture Analysis
**Last Updated:** 2025-10-07
**Next Review:** When first enterprise customer inquires about SSO
